$(function(){"use strict";var j={$postComment:$("#post-comment"),$textComments:$("#text-comments"),$wrapperStar:$("#wrapper-star"),$dataModelHook:$("#data-model-hook"),$emojis:$("#emojis")},w={nickname:"未来软件园网友",score:5},t=j.$dataModelHook.attr("data-allow-comment");$("#post-comment").click(function(e){if(1!=t)return $(this).find("#msg").text("该文章不允许评论！").css("display","block"),!1;var p=$(e.target);switch(p[0].className){case"post-btn":case"post-btn disabled":!function(e){var t=$("#ajax_code-img");{if($(e).hasClass("disabled"))return $("#msg").css("display","block");if(0<t.length&&0<t.length&&t.parent()[0]!=p.parent()[0])return t.appendTo(p.parent())}var s=$("#verify-code"),a=s.val();{if(0===t.length)return P(p);if(0===a.length)return alert("验证码不能为空");if(4!=a.length)return alert("请输入四位数验证码")}var o=j.$textComments.val(),i=j.$wrapperStar.attr("data-score")||w.score,n=j.$postComment.find(".nickname").val()||w.nickname,r=j.$dataModelHook.attr("data-model"),l=j.$dataModelHook.attr("data-res"),c=s.attr("data-session-name"),m={nickname:n,stars:i,content:o,model:r,res_id:l};m[c]=a,M(m),setTimeout(function(){P($("#post-comment #ajax_code-img"))},300)}(e.target)}}),j.$textComments.on("keyup change",function(){var e=$(this).val().length;e?($("#post-btn").removeClass("disabled"),$("#msg").css("display","")):$("#post-btn").addClass("disabled"),$("#word-count").text(e)}),$("#comment_wrapper").on("click",function(e){var t=$(e.target);if(t.is("textarea")){if(0<t.parent().siblings("#ajax_code-img").length)return;P(t.parent())}});var e=$(".comment-item"),i='<div class="reply-box" data-id="{{ id }}">{{ moreReplyBoxPlaceHolder }}<p class="head-line common_ovh"><span class="comment-author">{{ nickname }}</span><span class="comment-address"> [{{ ip_address }}网友] </span>发表评论说：<span class="comment-time">{{ add_time }}</span></p><p class="comment-text">{{ content }}</p><p class="comment-box-actions comment-actions"><span class="upvote">顶（{{ like }}）</span><span class="downvote">踩（{{ unlike }}）</span><span class="post-reply">回复</span></p></div>';e.each(function(e,t){var s=$(this).find(".replyBoxPlaceHolder");if(0<s.length){var a,o=JSON.parse(s.attr("data-replies"));o.length;$.each(o,function(e,t){0===e?a=i.replace("{{ id }}",t.id).replace("{{ nickname }}",t.nickname).replace("{{ ip_address }}",t.ip_address).replace("{{ add_time }}",function(){return n(1e3*t.add_time)}).replace("{{ content }}",t.content).replace("{{ like }}",t.like).replace("{{ unlike }}",t.unlike):0<e&&(a=a.replace("{{ moreReplyBoxPlaceHolder }}",function(){return i.replace("{{ id }}",t.id).replace("{{ nickname }}",t.nickname).replace("{{ ip_address }}",t.ip_address).replace("{{ add_time }}",function(){return n(1e3*t.add_time)}).replace("{{ content }}",t.content).replace("{{ like }}",t.like).replace("{{ unlike }}",t.unlike)}))}),a=a.replace("{{ moreReplyBoxPlaceHolder }}",""),s.html(a),s.attr("data-replies","")}});var C="dongdong_article_",H=JSON.parse(localStorage.getItem(C+"comment"))||{};$("#comment_wrapper").click(function(e){var t,s,a,o,i,n=$(e.target),r=n.parent().parent().attr("data-id");if(H[r]||(H[r]={}),n.hasClass("post-reply"))i=$(e.target).closest(".comment-actions"),function(){if(!S){var e=$('<div class="reply-text-wrapper">'),t=$('<div class="emoji-wrapper" id="reply-emoji-wrapper"><span class="icon-emoji" id="reply-icon-emoji"></span><div class="emojis" id="reply-emojis"><img src="/assets/emotion/01.gif" title="[s:鼓掌]"><img src="/assets/emotion/02.gif" title="[s:鄙视]"><img src="/assets/emotion/03.gif" title="[s:微笑]"><img src="/assets/emotion/04.gif" title="[s:大哭]"><img src="/assets/emotion/05.gif" title="[s:讨厌]"><img src="/assets/emotion/06.gif" title="[s:卖萌]"><img src="/assets/emotion/07.gif" title="[s:害羞]"><img src="/assets/emotion/08.gif" title="[s:吐血]"><img src="/assets/emotion/09.gif" title="[s:猥琐]"><img src="/assets/emotion/10.gif" title="[s:斜视]"><img src="/assets/emotion/11.gif" title="[s:眯眼]"><img src="/assets/emotion/12.gif" title="[s:木讷]"><img src="/assets/emotion/13.gif" title="[s:哭笑]"><img src="/assets/emotion/14.gif" title="[s:捏脸]"></div></div>'),s=$('<span class="word-count"><span class="count" id="reply-word-count">0</span>/120</span>'),a=$('<textarea maxlength="120" class="reply-textarea" placeholder="填写回复内容" required>'),o=$('<input type="text" class="reply-nickname" maxlength="12" placeholder="未来软件园网友（昵称）">'),i=$('<input type="submit" class="reply-submit-btn" value="提交回复">');S=$('<div class="reply-div-wrapper clearfix" id="reply-div-wrapper">').append(e.append(a,t,s),o,i)}}(),$(i).hasClass("reply")?($(i).removeClass("reply"),$("#reply-div-wrapper").remove()):($(".comment-actions.reply").removeClass("reply"),$(i).append(S).addClass("reply"));else if(n.hasClass("upvote"))H[r].upvoted||(a=r,o=$(e.target),$.ajax({url:"/tools/support_comment/"+a+"/1",type:"POST",success:function(e){if(e.code==T){var t=$(o).text();$(o).text(t.replace(/(\d+)/g,function(e){return Number(e)+1}))}}}),H[a].upvoted=!0,localStorage.setItem(C+"comment",JSON.stringify(H)));else if(n.hasClass("downvote"))H[r].downvoted||(t=r,s=$(e.target),$.ajax({url:"/tools/support_comment/"+t+"/0",type:"POST",success:function(e){if(e.code==T){var t=$(s).text();$(s).text(t.replace(/(\d+)/g,function(e){return Number(e)+1}))}}}),H[t].downvoted=!0,localStorage.setItem(C+"comment",JSON.stringify(H)));else if(n.hasClass("reply-submit-btn")){var l=$("#ajax_code-img");if(0<l.length&&l.parent()[0]!=n.parent()[0])return void l.appendTo(n.parent());var c=n.parent().find("textarea").val(),m=$("#verify-code"),p=m.val();if(0==c.length)return alert("请填写回复"),!1;if(0===l.length)return void P(n);if(0===p.length)return void alert("验证码不能为空");if(4!=p.length)return void alert("请输入四位数验证码");var d=n.siblings(".reply-nickname").val()||w.nickname,g=j.$dataModelHook.attr("data-model"),u=j.$dataModelHook.attr("data-res"),f=m.attr("data-session-name"),v=n.closest(".comment-actions"),y={nickname:d,content:c,model:g,res_id:u,parent_id:v.hasClass("comment-box-actions")?$(e.target).closest(".reply-box").attr("data-id"):v.closest(".comment-item").attr("data-id")};y[f]=p,M(y),setTimeout(function(){P($("#reply-div-wrapper #ajax_code-img"))},300)}else if(n.is(".more-comments.btn"));else if(n.is("#code_img")||n.is("#reload-code-img"))P(n.parent());else if(n.is("#reply-icon-emoji"))$("#reply-emojis").toggle();else if(n.is("#reply-emojis img")){var h=n.attr("title"),x=n.parents("#reply-emoji-wrapper").siblings("textarea"),k=x[0].selectionStart,_=x[0].selectionEnd,b=x.val();x.val(b.substr(0,k)+h+b.substr(_)),n.closest("#reply-emojis").hide(),x.focus(),x.trigger("change")}}),$("#comment_wrapper").on("change keyup keydown",function(e){var t=$(e.target);if(t.is(".reply-textarea")){var s=t.val().length;$("#reply-word-count").text(s),120<s&&t.val(t.val().substr(0,121))}}),$("#posted-comment").on("mouseover",function(e){var t=$(e.target).closest(".reply-box");0<t.length&&(e.stopPropagation(),t.children(".comment-box-actions").addClass("hover"))}).on("mouseout",function(e){var t=$(e.target).closest(".reply-box");0<t.length&&(e.stopPropagation(),t.children(".comment-box-actions").removeClass("hover"))});i='<div class="reply-box" data-id="{{ id }}">{{ moreReplyBoxPlaceHolder }}<p class="head-line common_ovh"><span class="comment-author">{{ nickname }}</span><span class="comment-address"> [{{ ip_address }}网友] </span>发表评论说：<span class="comment-time">{{ add_time }}</span></p><p class="comment-text">{{ content }}</p><p class="comment-box-actions comment-actions"><span class="upvote">顶（{{ like }}）</span><span class="downvote">踩（{{ unlike }}）</span><span class="post-reply">回复</span></p></div>';$("#emoji-wrapper").click(function(e){var t=$(e.target);if(t.is("#icon-emoji"))j.$emojis.children().length||j.$emojis.append('<img src="/assets/emotion/01.gif" title="[s:鼓掌]"><img src="/assets/emotion/02.gif" title="[s:鄙视]"><img src="/assets/emotion/03.gif" title="[s:微笑]"><img src="/assets/emotion/04.gif" title="[s:大哭]"><img src="/assets/emotion/05.gif" title="[s:讨厌]"><img src="/assets/emotion/06.gif" title="[s:卖萌]"><img src="/assets/emotion/07.gif" title="[s:害羞]"><img src="/assets/emotion/08.gif" title="[s:吐血]"><img src="/assets/emotion/09.gif" title="[s:猥琐]"><img src="/assets/emotion/10.gif" title="[s:斜视]"><img src="/assets/emotion/11.gif" title="[s:眯眼]"><img src="/assets/emotion/12.gif" title="[s:木讷]"><img src="/assets/emotion/13.gif" title="[s:哭笑]"><img src="/assets/emotion/14.gif" title="[s:捏脸]">'),$("#emojis").toggle();else if(t.is("img")){var s=t.attr("title"),a=$(this).siblings("textarea"),o=a[0].selectionStart,i=a[0].selectionEnd,n=a.val();a.val(n.substr(0,o)+s+n.substr(i)),t.closest("#emojis").hide(),a.focus(),j.$textComments.trigger("change")}});var S,a,T="200";function n(e){var t=new Date(e),s=t.getFullYear(),a=t.getMonth()+1,o=t.getDate(),i=t.getHours(),n=t.getMinutes();return s+"-"+(a=9<a?a:"0"+a)+"-"+(o=9<o?o:"0"+o)+" "+(i=9<i?i:"0"+i)+":"+(n=9<n?n:"0"+n)}function M(e){$.ajax({url:"/tools/comment_add",type:"POST",data:e,dataType:"json",success:function(e){e.code==T?(alert("提交评论成功，请静候审核通过。"),$("#text-comments, #nickname, .reply-textarea, .reply-nickname").val(""),$("#word-count, #reply-word-count").text("0"),$("#post-btn").addClass("disabled")):e.msg?alert(e.msg):alert("暂时无法提交评论，请稍后重试")}})}function P(s){$.ajax({url:"/tools/comment_code_img",type:"GET",success:function(e){var t=new Image;t.src=e.code_img_source,t.id="code_img",t.className="ajax_code_img",function(){var e=0,t=arguments.length;{if(a){for(a.empty();e<t;e++)a.append(arguments[e]);return}for(a=$('<div class="ajax_code-img" id="ajax_code-img">');e<t;e++)a.append(arguments[e])}}($('<input type="text" class="ajax_verify-code" maxlength="4" id="verify-code" data-session-name='+e.code_session_name+' placeholder="验证码">'),$(t),$('<span id="reload-code-img" class="change-code">换一换</span>')),$(s).parent().append(a)},error:function(e){return e.msg}})}setTimeout(function(){$.ajax({url:"/tools/stat/"+j.$dataModelHook.attr("data-model")+"/"+j.$dataModelHook.attr("data-res"),type:"GET",success:function(e){}})},1e3)});