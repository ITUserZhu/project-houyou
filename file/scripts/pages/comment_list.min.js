$(function(){"use strict";var w={$postComment:$("#post-comment"),$textComments:$("#text-comments"),$wrapperStar:$("#wrapper-star"),$dataModelHook:$("#data-model-hook")},j={nickname:"未来软件园网友",score:5},e=$(".comment-item"),n='<div class="reply-box" data-id="{{ id }}">{{ moreReplyBoxPlaceHolder }}<p class="head-line common_ovh"><span class="comment-author">{{ nickname }}</span><span class="comment-address"> [{{ ip_address }}网友] </span>发表评论说：<span class="comment-time">{{ add_time }}</span></p><p class="comment-text">{{ content }}</p><p class="comment-box-actions comment-actions"><span class="upvote">顶（{{ like }}）</span><span class="downvote">踩（{{ unlike }}）</span><span class="post-reply">回复</span></p></div>';e.each(function(e,t){var a=$(this).find(".replyBoxPlaceHolder");if(0<a.length){var s,r=JSON.parse(a.attr("data-replies"));r.length;$.each(r,function(e,t){0===e?s=n.replace("{{ id }}",t.id).replace("{{ nickname }}",t.nickname).replace("{{ ip_address }}",t.ip_address).replace("{{ add_time }}",function(){return o(1e3*t.add_time)}).replace("{{ content }}",t.content).replace("{{ like }}",t.like).replace("{{ unlike }}",t.unlike):0<e&&(s=s.replace("{{ moreReplyBoxPlaceHolder }}",function(){return n.replace("{{ id }}",t.id).replace("{{ nickname }}",t.nickname).replace("{{ ip_address }}",t.ip_address).replace("{{ add_time }}",function(){return o(1e3*t.add_time)}).replace("{{ content }}",t.content).replace("{{ like }}",t.like).replace("{{ unlike }}",t.unlike)}))}),s=s.replace("{{ moreReplyBoxPlaceHolder }}",""),a.html(s),a.attr("data-replies","")}}),$("#post-comment").click(function(e){var m=$(e.target);switch(m[0].className){case"post-btn":case"post-btn disabled":!function(e){var t=$("#ajax_code-img");{if($(e).hasClass("disabled"))return $("#msg").css("display","block");if(0<t.length&&0<t.length&&t.parent()[0]!=m.parent()[0])return t.appendTo(m.parent())}var a=$("#verify-code"),s=a.val();{if(0===t.length)return N(m);if(0===s.length)return alert("验证码不能为空");if(4!=s.length)return alert("请输入四位数验证码")}var r=w.$textComments.val(),n=w.$wrapperStar.attr("data-score")||j.score,o=w.$postComment.find(".nickname").val()||j.nickname,i=w.$dataModelHook.attr("data-model"),l=w.$dataModelHook.attr("data-res"),c=a.attr("data-session-name"),p={nickname:o,stars:n,content:r,model:i,res_id:l};p[c]=s,T(p),setTimeout(function(){N($("#post-comment #ajax_code-img"))},300)}(e.target);break;case"icon-star star-item":!function(e){var t=$(e).index()+1;$(e).siblings().css("color",""),$(e).parent(".wrapper-star").attr("data-score",t);for(;$(e).prev().length;)$(e).prev().add($(e)).css("color","#FFB527"),e=$(e).prev()}(m)}}),$("textarea#text-comments").on("keyup change",function(){var e=$(this).val().length;e?($("#post-btn").removeClass("disabled"),$("#msg").css("display","")):$("#post-btn").addClass("disabled"),$("#word-count").text(e)}),$("#comment_wrapper").on("click",function(e){var t=$(e.target);if(t.is("textarea")){if(0<t.parent().siblings("#ajax_code-img").length)return;N(t.parent())}});var C="dongdong_article_",S=JSON.parse(localStorage.getItem(C+"comment"))||{};$("#comment_wrapper").click(function(e){var t,a,s,r,n,o=$(e.target),i=o.parent().parent().attr("data-id");if(S[i]||(S[i]={}),o.hasClass("post-reply"))n=$(e.target).closest(".comment-actions"),function(){if(!H){var e=$('<div class="reply-text-wrapper">'),t=$('<div class="emoji-wrapper" id="reply-emoji-wrapper"><span class="icon-emoji" id="reply-icon-emoji"></span><div class="emojis" id="reply-emojis"><img src="/assets/emotion/01.gif" title="[s:鼓掌]"><img src="/assets/emotion/02.gif" title="[s:鄙视]"><img src="/assets/emotion/03.gif" title="[s:微笑]"><img src="/assets/emotion/04.gif" title="[s:大哭]"><img src="/assets/emotion/05.gif" title="[s:讨厌]"><img src="/assets/emotion/06.gif" title="[s:卖萌]"><img src="/assets/emotion/07.gif" title="[s:害羞]"><img src="/assets/emotion/08.gif" title="[s:吐血]"><img src="/assets/emotion/09.gif" title="[s:猥琐]"><img src="/assets/emotion/10.gif" title="[s:斜视]"><img src="/assets/emotion/11.gif" title="[s:眯眼]"><img src="/assets/emotion/12.gif" title="[s:木讷]"><img src="/assets/emotion/13.gif" title="[s:哭笑]"><img src="/assets/emotion/14.gif" title="[s:捏脸]"></div></div>'),a=$('<span class="word-count"><span class="count" id="reply-word-count">0</span>/120</span>'),s=$('<textarea maxlength="120" class="reply-textarea" placeholder="填写回复内容" required>'),r=$('<input type="text" class="reply-nickname" maxlength="12" placeholder="填写昵称">'),n=$('<input type="submit" class="reply-submit-btn" value="提交回复">');H=$('<div class="reply-div-wrapper clearfix" id="reply-div-wrapper">').append(e.append(s,t,a),r,n)}}(),$(n).hasClass("reply")?($(n).removeClass("reply"),$("#reply-div-wrapper").remove()):($(".comment-actions.reply").removeClass("reply"),$(n).append(H).addClass("reply"));else if(o.hasClass("upvote"))S[i].upvoted||(s=i,r=$(e.target),$.ajax({url:"/tools/support_comment/"+s+"/1",type:"POST",success:function(e){if(e.code==P){var t=$(r).text();$(r).text(t.replace(/(\d+)/g,function(e){return Number(e)+1}))}}}),S[s].upvoted=!0,localStorage.setItem(C+"comment",JSON.stringify(S)));else if(o.hasClass("downvote"))S[i].downvoted||(t=i,a=$(e.target),$.ajax({url:"/tools/support_comment/"+t+"/0",type:"POST",success:function(e){if(e.code==P){var t=$(a).text();$(a).text(t.replace(/(\d+)/g,function(e){return Number(e)+1}))}}}),S[t].downvoted=!0,localStorage.setItem(C+"comment",JSON.stringify(S)));else if(o.hasClass("reply-submit-btn")){var l=$("#ajax_code-img");if(0<l.length&&l.parent()[0]!=o.parent()[0])return void l.appendTo(o.parent());var c=o.parent().find("textarea").val(),p=$("#verify-code"),m=p.val();if(0==c.length)return alert("请填写回复"),!1;if(0===l.length)return void N(o);if(0===m.length)return void alert("验证码不能为空");if(4!=m.length)return void alert("请输入四位数验证码");var d=o.siblings(".reply-nickname").val()||j.nickname,g=w.$dataModelHook.attr("data-model"),u=w.$dataModelHook.attr("data-res"),f=p.attr("data-session-name"),v=o.closest(".comment-actions"),y={nickname:d,content:c,model:g,res_id:u,parent_id:v.hasClass("comment-box-actions")?$(e.target).closest(".reply-box").attr("data-id"):v.closest(".comment-item").attr("data-id")};y[f]=m,T(y),setTimeout(function(){N($("#reply-div-wrapper #ajax_code-img"))},300)}else if(o.is("#code_img")||o.is("#reload-code-img"))N(o.parent());else if(o.is("#reply-icon-emoji"))$("#reply-emojis").toggle();else if(o.is("#reply-emojis img")){var h=o.attr("title"),x=o.parents("#reply-emoji-wrapper").siblings("textarea"),k=x[0].selectionStart,_=x[0].selectionEnd,b=x.val();x.val(b.substr(0,k)+h+b.substr(_)),o.closest("#reply-emojis").hide(),x.focus(),x.trigger("change")}}),$("#comment_wrapper").on("change keyup keydown",function(e){var t=$(e.target);if(t.is(".reply-textarea")){var a=t.val().length;$("#reply-word-count").text(a),120<a&&t.val(t.val().substr(0,121))}}),$("#posted-comment").on("mouseover",function(e){var t=$(e.target).closest(".reply-box");0<t.length&&(e.stopPropagation(),t.children(".comment-box-actions").addClass("hover"))}).on("mouseout",function(e){var t=$(e.target).closest(".reply-box");0<t.length&&(e.stopPropagation(),t.children(".comment-box-actions").removeClass("hover"))}),$("#emoji-wrapper").click(function(e){var t=$(e.target);if(t.is("#icon-emoji"))$("#emojis").toggle();else if(t.is("img")){var a=t.attr("title"),s=$(this).siblings("textarea"),r=s[0].selectionStart,n=s[0].selectionEnd,o=s.val();s.val(o.substr(0,r)+a+o.substr(n)),t.closest("#emojis").hide(),s.focus(),s.trigger("change")}});var H,s,P="200";function o(e){var t=new Date(e),a=t.getFullYear(),s=t.getMonth()+1,r=t.getDate(),n=t.getHours(),o=t.getMinutes();return a+"-"+(s=9<s?s:"0"+s)+"-"+(r=9<r?r:"0"+r)+" "+(n=9<n?n:"0"+n)+":"+(o=9<o?o:"0"+o)}function T(e){$.ajax({url:"/tools/comment_add",type:"POST",data:e,dataType:"json",success:function(e){e.code==P?(alert("提交评论成功，请静候审核通过。"),$("#text-comments, #nickname, .reply-textarea, .reply-nickname").val(""),$("#word-count, #reply-word-count").text("0"),$("#post-btn").addClass("disabled")):e.msg?alert(e.msg):alert("暂时无法提交评论，请稍后重试")}})}function N(a){$.ajax({url:"/tools/comment_code_img",type:"GET",success:function(e){var t=new Image;t.src=e.code_img_source,t.id="code_img",t.className="ajax_code_img",function(){var e=0,t=arguments.length;{if(s){for(s.empty();e<t;e++)s.append(arguments[e]);return}for(s=$('<div class="ajax_code-img" id="ajax_code-img">');e<t;e++)s.append(arguments[e])}}($('<input type="text" class="ajax_verify-code" maxlength="4" id="verify-code" data-session-name='+e.code_session_name+' placeholder="验证码">'),$(t),$('<span id="reload-code-img" class="change-code">换一换</span>')),$(a).parent().append(s)},error:function(e){return e.msg}})}});