"use strict";var sentPayCodeIntervalId;function ajaxInterval(){sentPayCodeIntervalId=setInterval(function(){$.ajax({url:"/tools/get_pay_ok",type:"GET",success:function(e){200==e.code&&(alert("充值成功"),setTimeout(function(){window.location.reload()},2e3))}})},1e4)}$(function(){$("#login-ewm").click(function(e){$("#login-btn").click()});var e=$(".toggle-recharge"),a=$(".toggle-wra"),o=a.find(".toggle-item.active .details").width(),n=$(".pay-price"),r=a.find(".toggle-item.active .wraper").children("li").length,l=(a.find(".toggle-item.active .wraper").children("li").eq(0),0),s=0,d={};__commonToggleActive(a.find(".toggle-item.active .wraper").children("li").first()),d={id:a.find(".toggle-item.active .wraper").children("li").first().data("id"),price:a.find(".toggle-item.active .wraper").children("li").first().data("price")},n.text(d.price),e.click(function(e){var i=$(e.target).closest("a"),t=i.index();__commonToggleActive([a.children(".toggle-item").eq(t),i]),__commonToggleActive(a.find(".toggle-item.active .wraper").children("li").first()),d.id=a.find(".toggle-item.active .wraper").children("li").first().data("id"),d.price=a.find(".toggle-item.active .wraper").children("li").first().data("price"),n.text(d.price),p.removeClass("active"),v()}),a.click(function(e){var i=$(e.target),t=i.closest("div.arr"),a=$(this).find(".toggle-item.active .wraper");r=a.children("li").length;var c=a.hasClass("point")?l:s;if(t.is(".arr")){if(t.hasClass("left")){if(c<=0)return;c--}else if(t.hasClass("right")){if(c>=Math.ceil(r/3)-1)return;c++}a.animate({marginLeft:-c*o},400,function(){a.hasClass("point")?l=c:s=c})}i.closest("li.item").is(".item")&&(__commonToggleActive(i.closest("li.item")),d.id=i.closest("li.item").data("id"),d.price=i.closest("li.item").data("price"),n.text(d.price),p.removeClass("active"),v())});var i=$(".pay-type"),c=$(".pay-wra");i.click(function(e){var i=$(e.target).closest("a"),t=i.index();__commonToggleActive([c.children(".pay-wra-type").eq(t),i])}),$("#pay-ali").click(function(e){$("#ali_pay").val(d.id),$("#ali_pay_coupon").val(d.coupon_id)});var p=$("#coupon"),g=p.find("ul"),u=p.find(".coupon-num em"),f=0;p.click(function(e){var i=$(e.target);if(0!=u.text().replace("张可用","")){if(i.closest("ul").is(".coupon-wra"))return e.stopPropagation(),u.text("-"+i.closest("li").data("price")),g.slideUp(),$(this).addClass("active"),n.text(d.price-i.closest("li").data("price")),d.coupon_id=i.closest("li").data("id"),void h(d.id,1,d.coupon_id);if(i.is(".arr-down"))return e.stopPropagation(),void g.slideToggle();$(this).toggleClass("active"),$(this).hasClass("active")?g.slideDown():(g.slideUp(),u.text(f+"张可用"),n.text(d.price),d.coupon_id=0,h(d.id,1,d.coupon_id))}}),$.ajax({url:"/coupon_info",type:"POST",dataType:"json",data:{page:0,coupon_status:0},success:function(e){if(200!==e.code){var i=e.msg||"服务器错误，请刷新重试";return alert(i),void(scouponData=[])}m=e.coupon_info,v()},error:function(e){console.log(e.msg)}});var m=[];function v(){var t=new Array,a="";$.each(m,function(e,i){i.min_consume/1<=d.price&&(t.push(i),a+='<li data-id="{{ id }}" data-price="{{ d_price }}"><span class="discount-num">￥{{ price }}</span><div class="coupon-info"><p>满{{ min_price }}可用</p><p>{{ s_time }}-{{ e_time }}</p><span class="useCoupon">使用</span></div></li>'.replace("{{ price }}",i.coupon_point.replace(".00","")).replace("{{ min_price }}",i.min_consume).replace("{{ s_time }}",i.add_time).replace("{{ e_time }}",i.end_time).replace("{{ id }}",i.id).replace("{{ d_price }}",i.coupon_point.replace(".00","")))}),p.hasClass("active")||(f=t.length,u.text(f+"张可用")),g.empty().append(a),h(d.id,1,0)}var _=1;function h(e,i,t){i=i||_;$.ajax({url:"/tools/pay_code",type:"POST",data:{id:e,method:i,coupon_relation_id:t},dataType:"json",beforeSend:function(){$(".wxinqr").attr("src","/assets/images/loadcode.gif")},success:function(e){200==e.code?!1!==e.data?$(".wxinqr").prop("src",e.data):alert("请求二维码过于频繁，请稍后再试！"):alert("获取二维码失败，请重试")},error:function(e){}})}}),ajaxInterval();